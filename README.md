This is a wiremock tool demo framework.

### 1. Project configuration

#### 1.1. Install Python (3.12)
#### 1.2. Install poetry
```commandline
brew install poetry
```
or
```commandline
pip install poetry
```

#### 1.3. Clone Git repo
```commandline
git clone https://git.sbercloud.tech/cp/go/billing/wiremock-demo.git
```

#### 1.4. Install external libs using poetry (these libs are listed at pyproject.toml)
```commandline
cd billing-autotests
poetry env use 3.12
poetry install
```


### 6. External services mocking
For Service/E2E(local) tests we mock external services (like product-catalog,
product-inventory or customer-manager) with Wiremock tool. Mock server configuration and data files are placed at ./mock_server folder.

**Subfolders purposes:**
1. [ ./mock_server/certs ] Keeps SSL certificates (ask other members of the team for them)
2. [ ./mock_server/deps ] Keeps .proto files for mocked services
3. [ ./mock_server/stubs ] Contains stubs/messages/services definition files (generated by protoc tool)
4. [ ./mock_server/test ] Stores requests/responses mappings templates

In order to **run mock server locally** do the following:
1. Start mock server: ```docker-compose up mock-server```
2. Create data for mocked routes
```
curl -XPUT http://product-catalog:80/__admin/mappings/7f6d0e07-3ee0-4a8e-8db5-f04d19340ebf -d '{
    "name": "post_sku_service_get_sku_200",
    "request": {
        "method": "GET",
        "url": "/SkuService/GetSku"
    },
    "response": {
        "status": 200,
        "body": "{\"prices\": [{\"id\": \"406b5a10-3b83-4e15-9bd6-42fec5fd8530\", \"sku_id\": \"7a0e0492-21e8-4bcc-a851-59bcef4bc3f6\", ... }"
        "headers": {"Content-Type": "text/plain"}
    }
}'
```

3. Check data is stored at mock server
```
curl -XGET http://product-catalog:80/__admin/mappings
```

4. Send GRPC request to mocked handle in order to check that the data is applied
```
grpcurl --plaintext product-catalog:3010 sbercloud.cp.product.catalog.v3.SkuService/GetSku
```

5. Use `poetry update` if too much time lost after last try to write something here
